<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Begin Jekyll SEO tag v2.6.1 -->
    <title>TCP 长连接的最大个数 | some random rants</title>
    <meta name="generator" content="Jekyll v4.1.1" />
    <meta property="og:title" content="TCP 长连接的最大个数" />
    <meta property="og:locale" content="en_US" />
    <meta
      name="description"
      content="提个问题，单机单网卡最大对某个特定服务器 TCP 长连接的最大个数是多少？"
    />
    <meta
      property="og:description"
      content="提个问题，单机单网卡最大对某个特定服务器 TCP 长连接的最大个数是多少？"
    />
    <link
      rel="canonical"
      href="https://blog.k3fu.xyz/networking/2020/08/23/tcp-connections.html"
    />
    <meta
      property="og:url"
      content="https://blog.k3fu.xyz/networking/2020/08/23/tcp-connections.html"
    />
    <meta property="og:site_name" content="some random rants" />
    <meta property="og:type" content="article" />
    <meta
      property="article:published_time"
      content="2020-08-23T10:00:00+00:00"
    />
    <script type="application/ld+json">
      {
        "@type": "BlogPosting",
        "url": "https://blog.k3fu.xyz/networking/2020/08/23/tcp-connections.html",
        "headline": "TCP 长连接的最大个数",
        "dateModified": "2020-08-23T10:00:00+00:00",
        "datePublished": "2020-08-23T10:00:00+00:00",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://blog.k3fu.xyz/networking/2020/08/23/tcp-connections.html"
        },
        "description": "提个问题，单机单网卡最大对某个特定服务器 TCP 长连接的最大个数是多少？",
        "@context": "https://schema.org"
      }
    </script>
    <!-- End Jekyll SEO tag -->
    <link rel="stylesheet" href="/assets/main.css" />
    <link
      type="application/atom+xml"
      rel="alternate"
      href="https://blog.k3fu.xyz/feed.xml"
      title="some random rants"
    />
  </head>
  <body>
    <header class="site-header" role="banner">
      <div class="wrapper">
        <a class="site-title" rel="author" href="/">some random rants</a>
        <nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path
                  d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"
                />
              </svg>
            </span>
          </label>

          <div class="trigger">
            <a class="page-link" href="/about/">About</a>
          </div>
        </nav>
      </div>
    </header>
    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article
          class="post h-entry"
          itemscope
          itemtype="http://schema.org/BlogPosting"
        >
          <header class="post-header">
            <h1 class="post-title p-name" itemprop="name headline">
              TCP 长连接的最大个数
            </h1>
            <p class="post-meta">
              <time
                class="dt-published"
                datetime="2020-08-23T10:00:00+00:00"
                itemprop="datePublished"
                >Aug 23, 2020
              </time>
            </p>
          </header>

          <div class="post-content e-content" itemprop="articleBody">
            <p>
              提个问题，单机单网卡最大对某个特定服务器 TCP
              长连接的最大个数是多少？
            </p>

            <p>
              和平时一样，我们假设客户端是
              Linux。这可能不是一个生造出来的问题，想一想，如果我们希望设计一个支持长连接的代理服务器呢？如果有海量的客户端希望连接被代理的服务器呢？或者说我们希望为用户提供实时的消息服务呢？这是一种
              c1000k 问题。
            </p>

            <p>
              我们从 TCP
              协议开始，慢慢往外推，到操作系统直到硬件。看看一路上都有哪些限制。我们可以假设服务器是个怪物，它在
              TCP
              的框架下面可以有无穷的计算能力和带宽，各种资源取之不尽用之不竭。那么问题到了
              TCP。
            </p>

            <h1 id="tcp">TCP</h1>

            <h2 id="数据库问题">数据库问题</h2>

            <p>
              有人说，这是个数据库问题。因为 TCP 实现为了区别 TCP
              连接，用了个四元组标记每个 TCP 报文
            </p>

            <ul>
              <li>source ip: 32 bit for IPv4</li>
              <li>source port: 16 bit</li>
              <li>destination ip: 16 bit (fixed)</li>
              <li>destination port: 32 bit for IPv4 (fixed)</li>
            </ul>

            <p>
              所以这四个数字合起来，就是数据库的复合主键。其中，目标服务的 IP
              和端口都是固定的，所以我们只能从客户端这边发掘潜力：
            </p>

            <h3 id="source-ip">source ip</h3>

            <p>
              用
              <code class="language-plaintext highlighter-rouge">iproute2</code>
              可以为同一块网卡添加多个 IP 地址。理论上说，这就是
              <span class="katex"
                ><math xmlns="http://www.w3.org/1998/Math/MathML"
                  ><semantics
                    ><mrow
                      ><msup><mn>2</mn><mn>32</mn></msup></mrow
                    ><annotation encoding="application/x-tex"
                      >2^{32}</annotation
                    ></semantics
                  ></math
                ></span
              >
              个地址。
            </p>

            <div class="language-shell highlighter-rouge">
              <div class="highlight">
                <pre
                  class="highlight"
                ><code>ip addr add &lt;ip&gt;/&lt;network&gt; dev &lt;interface&gt;
</code></pre>
              </div>
            </div>

            <p>
              但是要细究的话，IPv4
              有很多特殊的地址段是不能使用或者使用上有限制的。如果服务器是对公网开放的，那么我们作为客户端就不能使用外部地址，只能用那些本地的地址，比如
              <code class="language-plaintext highlighter-rouge"
                >192.168.x.x</code
              >
              或者
              <code class="language-plaintext highlighter-rouge"
                >127.x.x.x</code
              >
              这些。如果使用 NAT/PAT 这类技术在内部实现 IP 复用，那么就需要把
              NAT 设备的限制考虑进去了。不管怎么样，数量级差不多是这个。
            </p>

            <h3 id="source-port">source port</h3>

            <p>
              对于特定目标地址，本地端口可以选择的区间是由
              <a
                href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt"
                >net.ipv4.ip_local_port_range</a
              >
              决定的。
            </p>

            <pre><code class="language-shellsession">$ cat /proc/sys/net/ipv4/ip_local_port_range
32768	60999
</code></pre>

            <p>
              对于给定的目标地址，以及给定的本地
              IP，可以发出的连接数量就是本地端口区间的大小。所以单个本地 IP
              最多可以产生 65535 个 TCP
              连接。为了打破这个限制，我们必须为网卡添加多个虚拟
              IP。满打满算，这就是
              <span class="katex"
                ><math xmlns="http://www.w3.org/1998/Math/MathML"
                  ><semantics
                    ><mrow
                      ><msup
                        ><mn>2</mn
                        ><mrow><mn>32</mn><mo>+</mo><mn>16</mn></mrow></msup
                      ></mrow
                    ><annotation encoding="application/x-tex"
                      >2^{32+16}</annotation
                    ></semantics
                  ></math
                ></span
              >
              个链接，约为
              281万亿。打个比方，我想开个公司，先从员工的工号的编码方式开始计划！嗯，就用
              IPv4 的地址和 16 位的端口号来吧，所以，我的公司最多支持
              281万亿个员工。这个思路扩展性很好，很强大！但是每个人都得发工资啊，我陷入了沉思……
            </p>

            <h2 id="tcp-的运行时开销">TCP 的运行时开销</h2>

            <h3 id="什么是-tcp-连接">什么是 TCP 连接</h3>

            <p>我们熟知的三次握手就能建立一个 TCP 连接</p>

            <ol>
              <li>SYN</li>
              <li>等待对方回应 SYN/ACK</li>
              <li>最后回答 ACK</li>
            </ol>

            <p>
              一旦双方完成这个规定的礼仪，就可以说这个连接建立了。一旦两边接上头，剩下的事情就是运行时的开销。
            </p>

            <h3 id="系统-tcp-协议栈">系统 TCP 协议栈</h3>

            <p>
              如果服务使用系统的 TCP
              协议栈，那么每个连接都需要占用一个文件描述符。回忆一下
              <code class="language-plaintext highlighter-rouge">send()</code>
              和
              <code class="language-plaintext highlighter-rouge">recv()</code
              >，它们的第一个参数是
              <code class="language-plaintext highlighter-rouge">socket</code
              >，而<code class="language-plaintext highlighter-rouge"
                >socket</code
              >
              可不就是个
              <code class="language-plaintext highlighter-rouge">fd</code>
              嘛。所以操作系统文件描述符的最大值，这个全局的
              <a href="https://www.kernel.org/doc/Documentation/sysctl/fs.txt"
                >设置</a
              >
              是
              <code class="language-plaintext highlighter-rouge"
                >fs.file-max</code
              >。在我的 RHEL8 上，它的值是
              <code class="language-plaintext highlighter-rouge">19603816</code
              >，接近两千万了。如果我们希望用单进程实现这个服务，还需要改
              <code class="language-plaintext highlighter-rouge"
                >ulimit -n</code
              >
              的限制。当然，如果内存够大，多操作系统或者用容器化的实现，以及用多进程的实现都可以越过这些限制。代价就是更多的额外开销。
            </p>

            <p>
              另外，还需要关注协议栈用到的缓冲区，看看
              <code class="language-plaintext highlighter-rouge"
                >net.ipv4.tcp_wmem</code
              >
              和
              <code class="language-plaintext highlighter-rouge"
                >net.ipv4.tcp_rmem</code
              >，在 RHEL8 上，它们的缺省大小分别是 85K 和
              16K。设置都有三组数字，分别是下限、缺省值和上限。以及
              <code class="language-plaintext highlighter-rouge"
                >net.ipv4.tcp_mem</code
              >，它控制着整个系统中所有 TCP
              缓冲区的总大小的上限。这个设置表示的是内存页的数量，有三组数字，分别是下限、警戒值和上限。如果
              TCP 缓冲空间总使用量达到上限之前，TCP 就会开始减少每个 TCP
              连接缓冲区的分配。一旦达到上限，TCP
              实现就开始丢包，希望减轻对内存系统的压力。
            </p>

            <pre><code class="language-shellsession">$ grep . /proc/sys/net/ipv4/tcp*mem
/proc/sys/net/ipv4/tcp_mem:2295903	3061204	4591806
/proc/sys/net/ipv4/tcp_rmem:4096	87380	6291456
/proc/sys/net/ipv4/tcp_wmem:4096	16384	4194304
</code></pre>

            <p>
              所以缺省设置下，最多使用 17G
              内存，可以同时支持二百万以上的长连接。
            </p>

            <p>
              Linux 下新的防火墙是使用 netfilter
              实现的，如果开启了防火墙那么还需要关注
            </p>

            <ul>
              <li>
                <code class="language-plaintext highlighter-rouge"
                  >net.ipv4.ip_conntrack_max</code
                >
              </li>
              <li>
                <code class="language-plaintext highlighter-rouge"
                  >net.ipv4.netfilter.ip_conntrack_max</code
                >
              </li>
            </ul>

            <p>
              netfilter 维护着一张哈希表用来跟踪所有的 TCP
              连接，所以如果这张表放不下新的 TCP 连接，TCP 就会开始丢包。
            </p>

            <h3 id="用户态-tcp-协议栈">用户态 TCP 协议栈</h3>

            <h3 id="带宽">带宽</h3>

            <p>
              需要估计所有连接中活跃的比例，并且需要了解活跃连接需要的带宽是多少。
            </p>

            <h3 id="内存">内存</h3>

            <p>
              前面如果使用系统的 TCP/IP 栈，就需要为每个连接保证
              <code class="language-plaintext highlighter-rouge"
                >tcp_rmem.min</code
              >
              +
              <code class="language-plaintext highlighter-rouge"
                >tcp_wmem.min</code
              >
              的空间。
            </p>
          </div>
          <a
            class="u-url"
            href="/networking/2020/08/23/tcp-connections.html"
            hidden
          ></a>
        </article>
      </div>
    </main>
    <footer class="site-footer h-card">
      <data class="u-url" href="/"></data>

      <div class="wrapper">
        <h2 class="footer-heading">some random rants</h2>

        <div class="footer-col-wrapper">
          <div class="footer-col footer-col-1">
            <ul class="contact-list">
              <li class="p-name">some random rants</li>
              <li>
                <a class="u-email" href="mailto:tchaikov@gmail.com"
                  >tchaikov@gmail.com</a
                >
              </li>
            </ul>
          </div>

          <div class="footer-col footer-col-2">
            <ul class="social-media-list">
              <li>
                <a href="https://github.com/tchaikov"
                  ><svg class="svg-icon">
                    <use
                      xlink:href="/assets/minima-social-icons.svg#github"
                    ></use>
                  </svg>
                  <span class="username">tchaikov</span></a
                >
              </li>
            </ul>
          </div>

          <div class="footer-col footer-col-3">
            <p>我的学习记录</p>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>
