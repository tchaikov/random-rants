<!DOCTYPE html>
<!--
    Type on Strap jekyll theme v2.4.4
    Theme free for personal and commercial use under the MIT license
    https://github.com/sylhare/Type-on-Strap/blob/master/LICENSE
-->
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=5"
    />

    <!-- Theme Mode-->

    <script>
      const isAutoTheme = true;
      document.documentElement.setAttribute(
        "data-theme",
        sessionStorage.getItem("theme")
      );
    </script>

    <!-- Main JS (navbar.js, katex_init.js and masonry_init.js)-->
    <script defer src="/assets/js/main.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css" />

    <!--Favicon-->
    <link rel="shortcut icon" href="" type="image/x-icon" />

    <!-- KaTeX 0.15.2 -->

    <script defer src="/assets/js/vendor/katex.min.js"></script>
    <script
      defer
      src="/assets/js/vendor/auto-render.min.js"
      onload="renderMathInElement(document.body);"
    ></script>

    <!-- Mermaid 9.1.1 -->

    <!-- Simple Jekyll Search 1.10.0 -->
    <script
      src="/assets/js/vendor/simple-jekyll-search.min.js"
      type="text/javascript"
    ></script>

    <!-- Google Analytics / Cookie Consent -->
    <script>
      const cookieName = "cookie-notice-dismissed-https://blog.k3fu.xyz";
      const isCookieConsent = "";
      const analyticsName = "";
      const analyticsNameGA4 = "";
    </script>

    <!-- seo tags -->
    <meta property="og:image" content="https://blog.k3fu.xyz/" />

    <meta property="og:type" content="website" />

    <!-- Begin Jekyll SEO tag v2.7.1 -->
    <title>Exception in Seastar | some random rants</title>
    <meta name="generator" content="Jekyll v4.1.1" />
    <meta property="og:title" content="Exception in Seastar" />
    <meta name="author" content="Kefu Chai" />
    <meta property="og:locale" content="en" />
    <meta name="description" content="时机永远很重要。" />
    <meta property="og:description" content="时机永远很重要。" />
    <link
      rel="canonical"
      href="https://blog.k3fu.xyz/seastar/2022/10/08/exception-in-seastar.html"
    />
    <meta
      property="og:url"
      content="https://blog.k3fu.xyz/seastar/2022/10/08/exception-in-seastar.html"
    />
    <meta property="og:site_name" content="some random rants" />
    <meta property="og:type" content="article" />
    <meta
      property="article:published_time"
      content="2022-10-08T00:00:00+00:00"
    />
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="Exception in Seastar" />
    <script type="application/ld+json">
      {
        "author": { "@type": "Person", "name": "Kefu Chai" },
        "description": "时机永远很重要。",
        "url": "https://blog.k3fu.xyz/seastar/2022/10/08/exception-in-seastar.html",
        "@type": "BlogPosting",
        "headline": "Exception in Seastar",
        "dateModified": "2022-10-08T00:00:00+00:00",
        "datePublished": "2022-10-08T00:00:00+00:00",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://blog.k3fu.xyz/seastar/2022/10/08/exception-in-seastar.html"
        },
        "@context": "https://schema.org"
      }
    </script>
    <!-- End Jekyll SEO tag -->

    <!-- RSS -->
    <link
      rel="alternate"
      type="application/atom+xml"
      title="some random rants"
      href="https://blog.k3fu.xyz/feed.xml"
    />
    <link
      type="application/atom+xml"
      rel="alternate"
      href="https://blog.k3fu.xyz/feed.xml"
      title="some random rants"
    />

    <!-- Twitter Cards -->
    <meta name="twitter:title" content="Exception in Seastar" />
    <meta name="twitter:description"
    content="时机永远很重要。先来一段代码seastar::future&lt;&gt; fail() { throw
    std::exception();}seastar::future&lt;&gt; f() { return fail().finally([] {
    std::cout &lt;&lt; "clea...">

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:image" content="https://blog.k3fu.xyz/" />
    <meta name="twitter:image:alt" content="Exception in Seastar" />
  </head>

  <body>
    <header class="site-header">
      <!-- Logo and title -->
      <div class="branding">
        <a class="site-title" aria-label="some random rants" href="/">
          some random rants
        </a>
      </div>

      <!-- Toggle menu -->
      <nav class="clear">
        <a aria-label="pull" id="pull" class="toggle" href="#">
          <i class="fas fa-bars fa-lg"></i>
        </a>

        <!-- Menu -->
        <ul class="hide">
          <li class="separator">|</li>
          <li>
            <a class="clear" aria-label="关于" title="关于" href="/about/">
              关于
            </a>
          </li>

          <li class="separator">|</li>
          <li>
            <a class="clear" aria-label="搜索" title="搜索" href="/search/">
              <i class="fas fa-search" aria-hidden="true"></i>
            </a>
          </li>

          <li class="separator">|</li>
          <li>
            <a class="clear" aria-label="Tags" title="Tags" href="/tags/">
              <i class="fas fa-tags" aria-hidden="true"></i>
            </a>
          </li>

          <li class="separator">|</li>
          <li>
            <a
              id="theme-toggle"
              title="Exception in Seastar "
              aria-label="Exception in Seastar"
              onclick="themeToggle()"
            ></a>
          </li>
        </ul>
      </nav>
    </header>

    <div class="content">
      <article>
        <header id="main" style="">
          <div class="title-padder">
            <h1 id="Exception+in+Seastar" class="title">
              Exception in Seastar
            </h1>

            <div class="post-info">
              <p class="meta">October 08, 2022</p>
            </div>
          </div>
        </header>

        <section class="post-content">
          <div class="paragraph">
            <p>时机永远很重要。</p>
          </div>
          <div class="paragraph">
            <p>先来一段代码</p>
          </div>
          <div class="listingblock">
            <div class="content">
              <pre
                class="rouge highlight"
              ><code data-lang="c++"><span class="n">seastar</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;&gt;</span> <span class="n">fail</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">seastar</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;&gt;</span> <span class="n">f</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">fail</span><span class="p">().</span><span class="n">finally</span><span class="p">([]</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"cleaning up</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre>
            </div>
          </div>
          <div class="paragraph">
            <p>
              试问
              <code>finally()</code>
              里面的代码会执行吗？答案是：“不会”。为什么呢？因为按照 C&#43;&#43;
              的话说，<code>fail().finally(&#8230;&#8203;)</code>
              是个表达式。表达式的结构类似:
            </p>
          </div>
          <div class="imageblock">
            <div class="content">
              <img
                src="/images/diag-6c6032f5a590fbd6ef42122e0ee858a4.png"
                alt="Diagram"
                width="590"
                height="448"
              />
            </div>
          </div>
          <div class="paragraph">
            <p>
              表达式的参数在求值之前都会准备好。但是求值的过程有点像深度优先的遍历。但是又不完全是，遍历的顺序同时需要遵循
              C&#43;&#43; 对各类表达式中的子表达式的求值顺序的要求。比如说，在
              C&#43;&#43;17
              之后，函数调用表达式中，其左边的参数即函数本身，需要在参数之前求值完毕，诸参数的求值顺序则没有要求。当所有参数都备好之后，再对函数调用，即
              <code>()</code>
              这个操作进行求值。如果在求值过程中抛出异常，那么我们就会走常规流程，比如说所有的变量都会销毁。而最顶层的函数调用因为其参数还没有准备好，所以也无法开始其求值的过程。整个表达式在一个
              <code>exception</code> 前瞬间土崩瓦解。因此上面的
              <code>f()</code> 无法 <strong>返回</strong>
              <code>seastar::future&lt;&gt;</code> ，而是给调用方抛出
              <code>exception</code>。
            </p>
          </div>
          <div class="paragraph">
            <p>再看看下面的代码：</p>
          </div>
          <div class="listingblock">
            <div class="content">
              <pre
                class="rouge highlight"
              ><code data-lang="c++"><span class="n">seastar</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;&gt;</span> <span class="n">fail</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">seastar</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;&gt;</span> <span class="n">f</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">seastar</span><span class="o">::</span><span class="n">sleep</span><span class="p">(</span><span class="mx">1s</span><span class="p">).</span><span class="n">then</span><span class="p">([]</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">fail</span><span class="p">();</span>
  <span class="p">}).</span><span class="n">finally</span><span class="p">([]</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"cleaning up</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre>
            </div>
          </div>
          <div class="paragraph">
            <p>
              这段代码中的 <code>finally()</code> 就会被调用。因为
              <code>then()</code> 后面的 lambda
              表达式在求值的时抛出的异常会被我们的 continuation
              实现捕捉住，放到对应的 promise 中，确保它返回的 future 的
              <code>finally()</code> 函数调用能对其做出处理。
            </p>
          </div>
          <div class="paragraph">
            <p>
              其实这个 caveat 在
              <a
                href="https://docs.seastar.io/master/tutorial.html#exceptions-vs.-exceptional-futures"
                >Seastar 的文档</a
              >
              里面有专门的章节解释。但是我之前并没有在意。
            </p>
          </div>
          <div class="paragraph">
            <p>在此引以为戒。</p>
          </div>
        </section>

        <!-- Social media shares -->

        <!-- Tag list -->

        <div class="tag-list"></div>
      </article>

      <!-- Post navigation -->

      <div id="post-nav">
        <div id="previous-post">
          <a alt="io_uring 和 EAGAIN" href="/2022/10/18/iouring-eagain.html">
            <p>Previous post</p>
            io_uring 和 EAGAIN
          </a>
        </div>

        <div id="next-post">
          <a alt="io_uring + Seastar" href="/2022/10/03/iouring-seastar.html">
            <p>Next post</p>
            io_uring + Seastar
          </a>
        </div>
      </div>

      <!--Utterances-->

      <!-- Cusdis -->
      <div
        class="comments"
        id="cusdis_thread"
        data-host="https://cusdis.com"
        data-app-id="12e099bc-c554-4827-aeb8-e425c83d8176"
        data-page-id="_posts/2022-10-08-exception-in-seastar.adoc"
        data-page-url="/seastar/2022/10/08/exception-in-seastar.html"
        data-page-title="Exception in Seastar"
        data-theme="auto"
      ></div>

      <script async src="https://cusdis.com/js/cusdis.es.js"></script>

      <!-- Disqus -->

      <!-- To change color of links in the page -->
      <style>
        header#main {
          background-size: cover;
          background-repeat: no-repeat;
          background-position: center;
        }
      </style>
    </div>
    <footer class="site-footer">
      <p class="text">
        Powered by <a href="https://jekyllrb.com/">Jekyll</a> with
        <a href="https://github.com/sylhare/Type-on-Strap">Type on Strap</a>
      </p>
      <div class="footer-icons">
        <ul>
          <!-- Social icons from Font Awesome, if enabled -->
        </ul>
      </div>
    </footer>
  </body>
</html>
