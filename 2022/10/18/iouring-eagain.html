<!DOCTYPE html>
<!--
    Type on Strap jekyll theme v2.4.4
    Theme free for personal and commercial use under the MIT license
    https://github.com/sylhare/Type-on-Strap/blob/master/LICENSE
-->
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=5"
    />

    <!-- Theme Mode-->

    <script>
      const isAutoTheme = true;
      document.documentElement.setAttribute(
        "data-theme",
        sessionStorage.getItem("theme")
      );
    </script>

    <!-- Main JS (navbar.js, katex_init.js and masonry_init.js)-->
    <script defer src="/assets/js/main.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css" />

    <!--Favicon-->
    <link rel="shortcut icon" href="" type="image/x-icon" />

    <!-- KaTeX 0.15.2 -->

    <script defer src="/assets/js/vendor/katex.min.js"></script>
    <script
      defer
      src="/assets/js/vendor/auto-render.min.js"
      onload="renderMathInElement(document.body);"
    ></script>

    <!-- Mermaid 9.1.1 -->

    <!-- Simple Jekyll Search 1.10.0 -->
    <script
      src="/assets/js/vendor/simple-jekyll-search.min.js"
      type="text/javascript"
    ></script>

    <!-- Google Analytics / Cookie Consent -->
    <script>
      const cookieName = "cookie-notice-dismissed-https://blog.k3fu.xyz";
      const isCookieConsent = "";
      const analyticsName = "";
      const analyticsNameGA4 = "";
    </script>

    <!-- seo tags -->
    <meta property="og:image" content="https://blog.k3fu.xyz/" />

    <meta property="og:type" content="website" />

    <!-- Begin Jekyll SEO tag v2.7.1 -->
    <title>io_uring 和 EAGAIN | some random rants</title>
    <meta name="generator" content="Jekyll v4.1.1" />
    <meta property="og:title" content="io_uring 和 EAGAIN" />
    <meta name="author" content="Kefu Chai" />
    <meta property="og:locale" content="en" />
    <meta
      name="description"
      content="io_uring 的 cqe 到底会不会返回 EAGAIN？"
    />
    <meta
      property="og:description"
      content="io_uring 的 cqe 到底会不会返回 EAGAIN？"
    />
    <link
      rel="canonical"
      href="https://blog.k3fu.xyz/2022/10/18/iouring-eagain.html"
    />
    <meta
      property="og:url"
      content="https://blog.k3fu.xyz/2022/10/18/iouring-eagain.html"
    />
    <meta property="og:site_name" content="some random rants" />
    <meta property="og:type" content="article" />
    <meta
      property="article:published_time"
      content="2022-10-18T00:00:00+00:00"
    />
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="io_uring 和 EAGAIN" />
    <script type="application/ld+json">
      {
        "author": { "@type": "Person", "name": "Kefu Chai" },
        "description": "io_uring 的 cqe 到底会不会返回 EAGAIN？",
        "url": "https://blog.k3fu.xyz/2022/10/18/iouring-eagain.html",
        "@type": "BlogPosting",
        "headline": "io_uring 和 EAGAIN",
        "dateModified": "2022-10-18T00:00:00+00:00",
        "datePublished": "2022-10-18T00:00:00+00:00",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://blog.k3fu.xyz/2022/10/18/iouring-eagain.html"
        },
        "@context": "https://schema.org"
      }
    </script>
    <!-- End Jekyll SEO tag -->

    <!-- RSS -->
    <link
      rel="alternate"
      type="application/atom+xml"
      title="some random rants"
      href="https://blog.k3fu.xyz/feed.xml"
    />
    <link
      type="application/atom+xml"
      rel="alternate"
      href="https://blog.k3fu.xyz/feed.xml"
      title="some random rants"
    />

    <!-- Twitter Cards -->
    <meta name="twitter:title" content="io_uring 和 EAGAIN" />
    <meta
      name="twitter:description"
      content="io_uring 的 cqe 到底会不会返回 EAGAIN？历史上的 O_NONBLOCK大家都知道 io_uring 是个异步的系统调用接口，它支持广泛的 IO 相关的调用。说到“异步”，就不得不提阻塞。我们在打开文件的时候，除了给出文件的路径之外，还可以指定一堆 flags。如果 flags 包含 O_NON..."
    />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:image" content="https://blog.k3fu.xyz/" />
    <meta name="twitter:image:alt" content="io_uring 和 EAGAIN" />
  </head>

  <body>
    <header class="site-header">
      <!-- Logo and title -->
      <div class="branding">
        <a class="site-title" aria-label="some random rants" href="/">
          some random rants
        </a>
      </div>

      <!-- Toggle menu -->
      <nav class="clear">
        <a aria-label="pull" id="pull" class="toggle" href="#">
          <i class="fas fa-bars fa-lg"></i>
        </a>

        <!-- Menu -->
        <ul class="hide">
          <li class="separator">|</li>
          <li>
            <a class="clear" aria-label="关于" title="关于" href="/about/">
              关于
            </a>
          </li>

          <li class="separator">|</li>
          <li>
            <a class="clear" aria-label="搜索" title="搜索" href="/search/">
              <i class="fas fa-search" aria-hidden="true"></i>
            </a>
          </li>

          <li class="separator">|</li>
          <li>
            <a class="clear" aria-label="Tags" title="Tags" href="/tags/">
              <i class="fas fa-tags" aria-hidden="true"></i>
            </a>
          </li>

          <li class="separator">|</li>
          <li>
            <a
              id="theme-toggle"
              title="io_uring 和 EAGAIN "
              aria-label="io_uring 和 EAGAIN"
              onclick="themeToggle()"
            ></a>
          </li>
        </ul>
      </nav>
    </header>

    <div class="content">
      <article>
        <header id="main" style="">
          <div class="title-padder">
            <h1 id="io_uring+%E5%92%8C+EAGAIN" class="title">
              io_uring 和 EAGAIN
            </h1>

            <div class="post-info">
              <p class="meta">October 18, 2022</p>
            </div>
          </div>
        </header>

        <section class="post-content">
          <div id="preamble">
            <div class="sectionbody">
              <div class="paragraph">
                <p>io_uring 的 cqe 到底会不会返回 <code>EAGAIN</code>？</p>
              </div>
            </div>
          </div>
          <div class="sect1">
            <h2 id="历史上的-o_nonblock">历史上的 <code>O_NONBLOCK</code></h2>
            <div class="sectionbody">
              <div class="paragraph">
                <p>
                  大家都知道 io_uring 是个异步的系统调用接口，它支持广泛的 IO
                  相关的调用。
                </p>
              </div>
              <div class="paragraph">
                <p>
                  说到“异步”，就不得不提阻塞。我们在打开文件的时候，除了给出文件的路径之外，还可以指定一堆
                  flags。如果 flags 包含
                  <code>O_NONBLOCK</code>，文件就会以非阻塞的模式打开。
                </p>
              </div>
              <div class="quoteblock">
                <blockquote>
                  <div class="paragraph">
                    <p>
                      When possible, the file is opened in nonblocking mode.
                      Neither the open() nor any subsequent I/O operations on
                      the file descriptor which is returned will cause the
                      calling process to wait.
                    </p>
                  </div>
                  <div class="paragraph">
                    <p>
                      Note that this flag has no effect for regular files and
                      block devices; that is, I/O operations will (briefly)
                      block when device activity is required, regardless of
                      whether O_NONBLOCK is set.
                    </p>
                  </div>
                </blockquote>
                <div class="attribution">&#8212; open(2)</div>
              </div>
              <div class="paragraph">
                <p>
                  manpage 说得清楚，普通文件和块设备不支持这个
                  <code>O_NONBLOCK</code>。写了也白写。APUE 解释了背后的原因：
                </p>
              </div>
              <div class="quoteblock">
                <blockquote>
                  <div class="paragraph">
                    <p>
                      We also said that system calls related to disk I/O are not
                      considered slow, even though the read or write of a disk
                      file can block the caller temporarily.
                    </p>
                  </div>
                </blockquote>
                <div class="attribution">&#8212; APUE 14.2</div>
              </div>
              <div class="paragraph">
                <p>
                  大概当初设计 UNIX 的大佬们认为文件读写不会
                  <strong>太</strong> 慢，所以不值得支持
                  <code>O_NONBLOCK</code>。不过用排除法可以知道，<code
                    >O_NONBLOCK</code
                  >
                  只支持
                </p>
              </div>
              <div class="ulist">
                <ul>
                  <li>
                    <p>tty 或者 ptty</p>
                  </li>
                  <li>
                    <p>pipe (管道)</p>
                  </li>
                  <li>
                    <p>FIFO (即有名管道)</p>
                  </li>
                  <li>
                    <p>socket</p>
                  </li>
                </ul>
              </div>
              <div class="paragraph">
                <p>
                  tty
                  当初是用电话线连接的，所以可能也会很慢。所以这些东西会涉及网络，以及一些无法确定的因素，所以有
                  <code>O_NONBLOCK</code> 的用武之地。另外，因为 pipe 和 FIFO
                  不是用 <code>open()</code> 调用打开的，所以需要用
                  <code>fcntl()</code> 设置一下。
                </p>
              </div>
            </div>
          </div>
          <div class="sect1">
            <h2 id="no-wait-aio">No Wait AIO</h2>
            <div class="sectionbody">
              <div class="paragraph">
                <p>
                  Linux 4.14 为了支持异步的 direct I/O，已经提供了返回
                  <code>EAGAIN</code> 的支持。见
                  <a href="https://lwn.net/Articles/722784/">No wait AIO</a>。
                  <a
                    href="https://man7.org/linux/man-pages/man2/io_submit.2.html"
                    >aio</a
                  >
                  通过 <code>iocb.aio_rw_flags</code> 的
                  <code>RWF_NOWAIT</code> 标志为应用提供非阻塞的文件或块设备的
                  IO 支持。新的 <code>preadv2()</code> 系统调用也通过 flags
                  参数为非阻塞的 IO 提供支持，
                </p>
              </div>
              <div class="quoteblock">
                <blockquote>
                  <div class="paragraph">
                    <p>RWF_NOWAIT (since Linux 4.14)</p>
                  </div>
                  <div class="paragraph">
                    <p>
                      Do not wait for data which is not immediately available.
                      If this flag is specified, the
                      <code>preadv2()</code> system call will return instantly
                      if it would have to read data from the backing storage or
                      wait for a lock. If some data was successfully read, it
                      will return the number of bytes read. If no bytes were
                      read, it will return -1 and set errno to
                      <code>EAGAIN</code> (but see BUGS). Currently, this flag
                      is meaningful only for <code>preadv2()</code>.
                    </p>
                  </div>
                </blockquote>
                <div class="attribution">&#8212; readv(2)</div>
              </div>
              <div class="paragraph">
                <p>
                  进一步解释一下。以读操作为例，<code>-EAGAIN</code>
                  并不意味着这个读操作会堵塞，而是说如果不等待读操作的话，是没有数据可读的。如果读取的是普通文件，那么
                  <code>RWF_NOWAIT</code> 会直接返回 page cache
                  里面已经有的数据，如果 page cache
                  里没有数据的话，就需要再发一个没有
                  <code>RWF_NOWAIT</code> 标记的读请求，真正的去把数据
                  <strong>读</strong>
                  出来。当然也可以采用预读的方式，自己实现读缓存。但是对于
                  io_uring 来说，这种设计就显得没什么必要了，因为如果数据在 page
                  cache 里的话，cqe 会在 submit sqe 调用返回之前就加入 cq
                  了。倘若数据不在 page cache 里， io_uring
                  也不会阻塞在发送请求的阶段，相反，它会在后台发起读请求，并异步地阻塞，等到数据来了，再发起重试，如果没有别人先把数据读走了的话，这次读操作就会触发
                  completion 事件，通知调用方。
                </p>
              </div>
            </div>
          </div>
          <div class="sect1">
            <h2 id="io_uring-什么时候返回-eagain">
              io_uring 什么时候返回 <code>-EAGAIN</code>
            </h2>
            <div class="sectionbody">
              <div class="paragraph">
                <p>
                  所以说，不管是文件还是网络，如果使用新的支持 flags 的 API 进行
                  IO 的话，我们都可以进行非阻塞的
                  IO。刚才解释了，只要我们主动要求
                  <code>RWF_NOWAIT</code>，那么就有机会得到
                  <code>EAGAIN</code>。那我们这里先关注 socket。如果 socket
                  在创建的时候，我们指定了
                  <code>O_NONBLOCK</code> 那么对它的操作时候是否会返回
                  <code>-EAGAIN</code> 呢？先看
                  <a
                    href="https://github.com/torvalds/linux/commit/355afaeb578abac907217c256a844cfafb0337b2"
                    >355afaeb</a
                  >。这个 commit 希望确立的行为是：
                </p>
              </div>
              <div class="ulist">
                <ul>
                  <li>
                    <p>
                      <code>-EAGAIN</code>
                      的重试处理，仅仅适用于块设备或者普通文件。如果当前操作的
                      fd 两个都不是，
                      那么就立即停止重试的流程。换言之，只有块设备或者普通文件才需要重试，
                      因为它们传统上是不允许返回 <code>-EAGAIN</code> 的。
                    </p>
                  </li>
                  <li>
                    <p>
                      如果对 nonblock 文件的 IO 返回了
                      <code>-EAGAIN</code>，则不需要为其设置 poll handler。
                      这种情况就 <strong>应该</strong> 返回
                      <code>-EAGAIN</code>。
                    </p>
                  </li>
                </ul>
              </div>
              <div class="paragraph">
                <p>
                  第一个行为在 io_uring
                  后续的修改中加入了更细致的判断，即如果块设备或者普通文件支持前述的
                  nowait
                </p>
              </div>
              <div class="paragraph">
                <p>
                  在
                  <a
                    href="https://github.com/torvalds/linux/commit/e697deed834de15d2322d0619d51893022c90ea2"
                    >e697de</a
                  >
                  中，也贯彻了这个方针。即，“如果 fd 有
                  <code>O_NONBLOCK</code
                  >，那么任何操作没能立即返回数据，都应该返回
                  <code>-EAGAIN</code>”。
                </p>
              </div>
            </div>
          </div>
        </section>

        <!-- Social media shares -->

        <!-- Tag list -->

        <div class="tag-list">
          <ul>
            <li class="meta">Tag</li>

            <li>
              <a class="button" href="/tags#io_uring">
                <p><i class="fas fa-tag fa-fw fa-sm"></i> io_uring</p>
              </a>
            </li>
          </ul>
        </div>
      </article>

      <!-- Post navigation -->

      <div id="post-nav">
        <div id="previous-post">
          <a alt="maybe_yield_awaiter" href="/2023/07/26/maybe-yield.html">
            <p>Previous post</p>
            maybe_yield_awaiter
          </a>
        </div>

        <div id="next-post">
          <a
            alt="Exception in Seastar"
            href="/seastar/2022/10/08/exception-in-seastar.html"
          >
            <p>Next post</p>
            Exception in Seastar
          </a>
        </div>
      </div>

      <!--Utterances-->

      <!-- Cusdis -->
      <div
        class="comments"
        id="cusdis_thread"
        data-host="https://cusdis.com"
        data-app-id="12e099bc-c554-4827-aeb8-e425c83d8176"
        data-page-id="_posts/2022-10-18-iouring-eagain.adoc"
        data-page-url="/2022/10/18/iouring-eagain.html"
        data-page-title="io_uring 和 EAGAIN"
        data-theme="auto"
      ></div>

      <script async src="https://cusdis.com/js/cusdis.es.js"></script>

      <!-- Disqus -->

      <!-- To change color of links in the page -->
      <style>
        header#main {
          background-size: cover;
          background-repeat: no-repeat;
          background-position: center;
        }
      </style>
    </div>
    <footer class="site-footer">
      <p class="text">
        Powered by <a href="https://jekyllrb.com/">Jekyll</a> with
        <a href="https://github.com/sylhare/Type-on-Strap">Type on Strap</a>
      </p>
      <div class="footer-icons">
        <ul>
          <!-- Social icons from Font Awesome, if enabled -->
        </ul>
      </div>
    </footer>
  </body>
</html>
